<!doctype html>
<html>
  <head>
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script>
    (function($) {
      $(function() {
        var socket = io.connect(document.URL),
          boards = $('#leaderboards'),
          login = $('#login'),
          new_user = $('#new'),
          game = $('#game'),
          chat = $('#chat'),
          errors = $('.errors'),
          user = { name: '', points: 0 };
        game
          .on({
            update_points: function(e) {
              if (e.hasOwnProperty('points')) {
                $('h1', this).text(user.name + ' - ' + e.points + ' points');
              }
            }
          });
        $('form', login)
          .on({
            submit: function(e) {
              e.preventDefault();
              var name = $('input', this).val();
              if (name.length) {
                socket.emit('join', { user: name });
              }
              return false;
            }
          });
        $('form', new_user)
          .on({
            submit: function(e) {
              e.preventDefault();
              var name = $('input', this).val();
              if (name.length) {
                socket.emit('new', { user: name });
              }
              return false;
            }
          });
        socket.on('leaderboards', function(data) {
          if (data.hasOwnProperty('users')) {
            var list = $('ul', boards), 
              new_list = $('<ul />'),
              i, user;
           
            for (i in data.users) {
              if (data.users.hasOwnProperty(i)) {
                user = data.users[i];
                new_list.append($('<li />').text(user.name + ' - ' + user.points + ' points'));
              }
            }
            list.replaceWith(new_list);
          }
        });
        socket.on('no let in', function(data) {
          errors.text("user doesn't exist");
        });
        socket.on('let in', function(data) {
          errors.text('');
          if (data.hasOwnProperty('user')) {
            var game_form = $('form', game);
            user = data.user;
            login.hide();
            new_user.hide();
            chat.show();
            game.show();
            game.trigger({
              type: 'update_points',
              points: user.points
            });
          $('form', chat)
            .on({
              submit: function(e) {
                e.preventDefault();
                var input = $('input', this),
                  text = input.val();
                if (text.length) {
                  socket.emit('chat send', { text: text, user: user.name });
                  input.val('');
                }
                return false;
              }
            });
            game_form
              .on({
                submit: function(e) {
                  e.preventDefault();
                  var input = $('input', this);
                  socket.emit('answer', { answer: input.val(), user: user.name });
                  $(this).hide();
                  input.remove();
                  return false;
                }
              });
            socket.on('chat update', function(data) {
              var box = $('textarea', chat),
                text = box.text(),
                i;
              if (data.hasOwnProperty('log')) {
                text = '';
                for (i in data.log) {
                  if (data.log.hasOwnProperty(i)) {
                    text = text + "\n" + data.log[i];
                  }
                }
              }
              if (data.hasOwnProperty('line')) {
                text = text + "\n" + data.line;
              }
              box.text(text);
            });
            socket.on('question', function(data) {
              if (data.hasOwnProperty('question')) {
                $('.question span', game).text(data.question);
                $('input', game_form).remove();
                $('.message', game).text('');
                game_form
                  .prepend($('<input type="text" />'))
                  .show();
              }
            });
            socket.on('update_points', function(data) {
              var message = '';
              if (data.hasOwnProperty('msg')) {
                message = data.msg;
              }
              if (data.hasOwnProperty('user') && data.hasOwnProperty('points')) {
                if (user.name === data.user) {
                  game.trigger({
                    type: 'update_points',
                    points: data.points 
                  });
                } else {
                  $('.message', game).text(message);
                }
              }             
            });
          }
        });
      });
    }(jQuery));
    </script>
  </head>
  <body>
    <p class="errors"></p>
    <div id="login">
      <form action="/" method="post">
        <input type="text" name="login" />
        <button>Join</button>
      </form>
    </div>
    <div id="new">
      <form action="/" method="post">
        <input type="text" name="new" />
        <button>Create &amp; Join</button>
      </form>
    </div>
    <div id="game" style="display: none;">
      <h1></h1>
      <p class="question">Question: <span></span></p>
      <form action="/" method="post" style="display: none;">
        <button>Answer</button>
      </form>
      <p class="message"></p>
    </div>
    <div id="chat" style="display: none;">
      <h2>Chat here:</h2>
      <textarea disabled="disabled"></textarea>
      <form action="/" method="post">
        <input type="text" />
        <button>Send</button>
      </form>
    </div>
    <div id="leaderboards">
      <h2>Leaderboards</h2>
      <ul></ul>
    </div>
  </body>
</html>
